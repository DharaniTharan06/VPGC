<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM Placement Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --backgroundTeal: #FFFFFF;
            --darkTeal: #00695C;
            --primaryText: #212121;
            --secondaryText: #9E9E9E;
            --cardWhite: #E0F2F1; 
            --lightTeal: #80CBC4;
            --mediumTeal: #26A69A;
            --borderGrey: #BDBDBD;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--backgroundTeal);
            color: var(--primaryText);
            margin: 0;
            padding: 20px;
        }

        h1, h3 {
            color: var(--darkTeal);
            font-weight: 600;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--cardWhite);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--borderGrey);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        button {
            background: linear-gradient(45deg, var(--darkTeal), var(--mediumTeal));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: var(--lightTeal);
            color: var(--primaryText);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-item h4 {
            margin: 0 0 5px 0;
            font-size: 0.9em;
            color: var(--darkTeal);
        }

        .stat-item span {
            font-size: 1.5em;
            font-weight: bold;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; margin-bottom: 30px;">VM Placement Optimization Dashboard</h1>
    
    <div class="dashboard">
        <div class="card">
            <h3>System Control</h3>
            <button onclick="optimizePlacement()" id="optimizeBtn">Run Optimization</button>
            <button onclick="refreshStats()" id="refreshBtn">Refresh Stats</button>
            <div class="success-message" id="successMsg"></div>
            <div class="error-message" id="errorMsg"></div>
        </div>
        
        <div class="card">
            <h3>Live Performance Metrics</h3>
            <canvas id="performanceRadarChart" height="150"></canvas>
        </div>
        
        <div class="card full-width">
            <h3>Algorithm Comparison</h3>
            <canvas id="comparisonChart" height="100"></canvas>
        </div>
    
        <div class="card">
            <h3>Node Utilization</h3>
            <canvas id="utilizationChart" height="150"></canvas>
        </div>
        
        <div class="card">
            <h3>Blockchain Status</h3>
            <div id="blockchain-status" class="stats">
                <div class="stat-item"><h4>Loading...</h4><span>...</span></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        let utilizationChart, comparisonChart, performanceRadarChart;

        Chart.defaults.color = '#212121';
        Chart.defaults.borderColor = 'rgba(0, 105, 92, 0.1)'; 
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';

        function showError(message) {
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
            setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
        }

        function showSuccess(message) {
            const successMsg = document.getElementById('successMsg');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            setTimeout(() => { successMsg.style.display = 'none'; }, 5000);
        }

        function initializeCharts() {
            const utilCtx = document.getElementById('utilizationChart').getContext('2d');
            utilizationChart = new Chart(utilCtx, {
                type: 'bar',
                data: { 
                    labels: [], 
                    datasets: [
                        { label: 'CPU Utilization %', data: [], backgroundColor: '#26A69A' },
                        { label: 'Memory Utilization %', data: [], backgroundColor: '#80CBC4' }
                    ]
                },
                options: { 
                    responsive: true, 
                    scales: { 
                        y: { beginAtZero: true, max: 100 } 
                    } 
                }
            });

            const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(comparisonCtx, {
                type: 'bar', 
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    plugins: {
                        title: { 
                            display: true, 
                            text: 'Model Performance vs. Standard Algorithms', 
                            font: { size: 16 } 
                        },
                        tooltip: { 
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        let explanation = ' (Lower is Better)';
                                        if(context.label.includes('SLA')) explanation = ' (Higher % is Worse)';
                                        label += context.parsed.y + explanation;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Metric Value' } 
                        } 
                    }
                }
            });

            const radarCtx = document.getElementById('performanceRadarChart').getContext('2d');
            performanceRadarChart = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['Success Rate', 'Avg CPU Util', 'Avg Mem Util', 'Load Balance', 'Tx Throughput'],
                    datasets: [{
                        label: 'Your Model Performance (Normalized)',
                        data: [0, 0, 0, 0, 0],
                        fill: true,
                        backgroundColor: 'rgba(0, 105, 92, 0.2)',
                        borderColor: '#00695C',
                        pointBackgroundColor: '#00695C',
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        r: { 
                            angleLines: { display: true }, 
                            suggestedMin: 0, 
                            suggestedMax: 1, 
                            ticks: { display: false },
                            pointLabels: { font: { size: 14 } } 
                        } 
                    }
                }
            });
        }
        
        async function optimizePlacement() {
            const btn = document.getElementById('optimizeBtn');
            btn.disabled = true;
            btn.textContent = 'Optimizing...';
            
            try {
                const response = await fetch(API_BASE + '/optimize', {method: 'POST'});
                if (!response.ok) {
                    throw new Error('Server returned ' + response.status);
                }
                const result = await response.json();
                showSuccess('Optimization complete! Block ' + result.block_id + ' mined with ' + result.transactions + ' transactions.');
                await refreshStats();
            } catch (error) {
                showError('Error optimizing placement: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Optimization';
            }
        }
        
        async function refreshStats() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            
            try {
                const response = await fetch(API_BASE + '/stats');
                if (!response.ok) {
                    throw new Error('Server returned ' + response.status);
                }
                const stats = await response.json();
                
                const utilLabels = stats.node_statistics.map(n => n.node_id);
                const cpuData = stats.node_statistics.map(n => (n.cpu_utilization * 100).toFixed(1));
                const memoryData = stats.node_statistics.map(n => (n.memory_utilization * 100).toFixed(1));
                utilizationChart.data.labels = utilLabels;
                utilizationChart.data.datasets[0].data = cpuData;
                utilizationChart.data.datasets[1].data = memoryData;
                utilizationChart.update();
                
                if (stats.comparison_data) {
                    const themeColors = ['#00695C', '#26A69A', '#80CBC4', '#B3E5E2'];
                    stats.comparison_data.datasets.forEach((dataset, index) => {
                        dataset.backgroundColor = themeColors[index % themeColors.length];
                    });
                    comparisonChart.data.labels = stats.comparison_data.labels;
                    comparisonChart.data.datasets = stats.comparison_data.datasets;
                    comparisonChart.update();
                }

                if (stats.performance_metrics) {
                    const metrics = stats.performance_metrics;
                    const successRate = metrics.success_rate;

                    const activeCpuNodes = cpuData.filter(d => d > 0);
                    const avgCpuUtil = activeCpuNodes.length > 0 ? 
                        (activeCpuNodes.map(Number).reduce((a, b) => a + b, 0) / activeCpuNodes.length) / 100 : 0;
                    
                    const activeMemNodes = memoryData.filter(d => d > 0);
                    const avgMemUtil = activeMemNodes.length > 0 ? 
                        (activeMemNodes.map(Number).reduce((a, b) => a + b, 0) / activeMemNodes.length) / 100 : 0;

                    const loadBalanceScore = 1 - (Math.min(metrics.load_balance_variance, 0.1) / 0.1); 
                    const txThroughput = stats.blockchain_blocks > 1 ? 1 : 0;

                    performanceRadarChart.data.datasets[0].data = [
                        successRate.toFixed(2),
                        avgCpuUtil.toFixed(2),
                        avgMemUtil.toFixed(2),
                        loadBalanceScore.toFixed(2),
                        txThroughput.toFixed(2)
                    ];
                    performanceRadarChart.update();
                }

                const blockchainResponse = await fetch(API_BASE + '/blockchain');
                if (!blockchainResponse.ok) {
                    throw new Error('Failed to fetch blockchain info');
                }
                const blockchainInfo = await blockchainResponse.json();
                
                document.getElementById('blockchain-status').innerHTML = 
                    '<div class="stat-item"><h4>Blocks</h4><span>' + blockchainInfo.blocks + '</span></div>' +
                    '<div class="stat-item"><h4>Pending TXs</h4><span>' + blockchainInfo.pending_transactions + '</span></div>' +
                    '<div class="stat-item"><h4>Integrity</h4><span style="color: ' + 
                    (blockchainInfo.is_valid ? '#00695C' : '#F44336') + '; font-weight: bold;">' +
                    (blockchainInfo.is_valid ? 'VALID' : 'INVALID') + '</span></div>';

            } catch (error) {
                showError('Error refreshing stats: ' + error.message);
                console.error('Error refreshing stats:', error);
            } finally {
                btn.disabled = false;
            }
        }
        
        window.onload = () => {
            initializeCharts();
            refreshStats();
            setInterval(refreshStats, 30000);
        };
    </script>
</body>
</html>